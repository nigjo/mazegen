<!DOCTYPE html>
<html>
  <head>
    <title>Dock Runner</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" sizes="16x16" href="res/dock_runner-16.png" type="image/png">
    <link rel="icon" sizes="48x48" href="res/dock_runner-48.png" type="image/png">
    <link rel="icon" sizes="192x192" href="res/dock_runner-192.png" type="image/png">
    <link rel="icon" sizes="any" href="res/dock_runner.svg" type="image/svg+xml">
    <link rel="apple-touch-icon" type="image/png" sizes="180x180" href="res/dock_runner-180.png">
    <script type="module">
      import MazeGen from './res/RandomKruskal.js';
      import MazeView from './res/v_topdown.js';
      //import DebugView from './res/v_textview.js';
      const docrunner = {
        Width: '6',
        Height: '10',
        Seed: (() => {
          let timestamp = new Date();
          timestamp.setMinutes(0);
          return timestamp
                  .toISOString()
                  .substring(0, 16).replace('T', ' ') + 'z';
        })()
      };
      console.log('GAME', docrunner);
      document.getElementById('seed').textContent = docrunner.Seed;
      const maze = new MazeGen(Number(docrunner.Width), Number(docrunner.Height), docrunner.Seed);
      const view = new MazeView(maze);

      const startCell = maze.exit;
      const targetCell = maze.entrance;

      //console.debug('GAME', startCell, targetCell);

      let wrapper = document.createElement('div');
      wrapper.className = 'mazeview';
      let shadow = wrapper.attachShadow({
        mode: 'open'
      });
      let img = view.create();
      shadow.append(img);
      if (img.hasAttribute('width'))
        wrapper.dataset.width = Number(img.getAttribute('width')) + 'px';
      if (img.hasAttribute('height'))
        wrapper.dataset.height = Number(img.getAttribute('height')) + 'px';

      let w = Number(view.cellWidth);
      let h = Number(view.cellHeight);
      let oX = Number(view.offsetX);
      let oY = Number(view.offsetY);

      img.setAttribute('width', w * 4);
      img.setAttribute('height', h * 4);
      img.setAttribute('viewBox',
              (oX + w * startCell.col) + ' '
              + (oY + h * startCell.row) + ' ' + w + ' ' + h);
      img.setAttribute('part', 'mazeview');

      document.querySelector('main .game').append(wrapper);
      try {
        document.querySelector('main').append(new DebugView(maze).create());
      } catch (e) {
        console.debug("debug mode disabled");
      }

      let currentCell = startCell;
      let moving = false;
      let timer = null;
      let startTime = null;
      function startTimer() {
        if (timer)
          return;
        startTime = Date.now();
        timer = setTimeout(updateTimer, 0);
      }
      function updateTimer() {
        let currentTime = Date.now();
        let delta = currentTime - startTime;
        const ui = document.getElementById('timer');
        ui.textContent = 'timer: ' + Math.floor(delta / 1000) + 's';
        if (timer) {
          timer = setTimeout(updateTimer, 150);
        } else {
          let a = document.createElement('a');
          a.href = './index.html?width=6&height=10&view=view5000';
          a.textContent = ui.textContent + " / done";
          ui.replaceChildren(a);
        }
      }
      function stopTimer() {
        timer = null;
      }

      document.addEventListener('keydown', (evt) => {
        if (event.isComposing || event.keyCode === 229) {
          //from mdn docs
          return;
        }
        if (moving) {
          switch (event.key) {
            case 'ArrowUp':
            case 'ArrowLeft':
            case 'ArrowDown':
            case 'ArrowRight':
              event.preventDefault();
              return;
          }
        }
        let nextCell = null;
        switch (event.key) {
          case 'ArrowUp':
            //if(currentCell.wall)
            if ((currentCell.walls & MazeGen.NORTH) === 0) {
              nextCell = currentCell.parent.getNeighbour(currentCell, MazeGen.NORTH);
            }
            break;
          case 'ArrowLeft':
            if ((currentCell.walls & MazeGen.WEST) === 0) {
              nextCell = currentCell.parent.getNeighbour(currentCell, MazeGen.WEST);
            }
            break;
          case 'ArrowDown':
            if ((currentCell.walls & MazeGen.SOUTH) === 0) {
              nextCell = currentCell.parent.getNeighbour(currentCell, MazeGen.SOUTH);
            }
            break;
          case 'ArrowRight':
            if ((currentCell.walls & MazeGen.EAST) === 0) {
              nextCell = currentCell.parent.getNeighbour(currentCell, MazeGen.EAST);
            }
            break;
          default:
            return;
        }
        startTimer();
        event.preventDefault();
        //console.debug(currentCell);
        if (nextCell) {
          const currentX = oX + w * currentCell.col;
          const currentY = oY + h * currentCell.row;
          const targetX = oX + w * nextCell.col;
          const targetY = oY + h * nextCell.row;
          const deltaX = (currentX - targetX) / 8;
          const deltaY = (currentY - targetY) / 8;
          let step = 0;
          moving = true;

          function move() {
            ++step;
            let nextX = currentX - step * deltaX;
            let nextY = currentY - step * deltaY;
            if (Math.abs(nextX - targetX) < 0.1
                    && (Math.abs(nextY - targetY) < 0.1)) {
              currentCell = nextCell;
              img.setAttribute('viewBox',
                      (targetX) + ' ' + (targetY) + ' ' + w + ' ' + h);
              moving = false;
              //console.debug('GAME', "move", "done");
              if (nextCell === targetCell) {
                moving = true; // verhindert weitere Bewegung
                stopTimer();
              }
            } else {
              //console.debug('GAME', "move", "next");
              img.setAttribute('viewBox',
                      (nextX) + ' ' + (nextY) + ' ' + w + ' ' + h);
              setTimeout(move, 66);
            }
          }
          setTimeout(move, 0);
        }
      });
    </script>
    <style>
      body{
        font-family: sans-serif;
      }
      .game{
        display:inline-block;
        margin:0;
        padding:1em;
        background-color:navy;
        line-height:0px;
      }
      @media screen and (max-width: 640px) {
        .game{
          width:calc(100% - 2em);
        }
        .mazeview::part(mazeview){
          width: 100%;
          height:auto;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <h1>Dock Runner</h1>
      <h2 id="seed">seed</h2>
    </header>
    <nav></nav>
    <main>
      <div class="game"></div>
      <p id="timer">
        Ready. Steady. GO!
      </p>
    </main>
    <footer>
      <a style="text-decoration:none;color:inherit;" href="index.html">&copy;</a> <a href="https://github.com/nigjo/mazegen/">Nigjo Iqn</a>
    </footer>
  </body>
</html>
